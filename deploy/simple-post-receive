#!/bin/bash
# Simple post-receive hook for updating existing Docker deployment

set -e

# Configuration
WORK_TREE="/path/to/your/pebbling-club"  # Update this to your repo path
BRANCH="main"  # Branch to deploy

echo "=== Deploying Pebbling Club ==="

# Check if we're pushing to the right branch
while read oldrev newrev refname; do
    if [[ $refname = "refs/heads/$BRANCH" ]]; then
        echo "Updating $BRANCH branch..."
        
        # Update the working tree
        git --work-tree="$WORK_TREE" --git-dir="$GIT_DIR" checkout -f "$BRANCH"
        
        cd "$WORK_TREE"
        
        # Pull new images and rebuild
        echo "Rebuilding Docker containers..."
        docker-compose -f docker/compose/docker-compose.yml build
        
        # Run migrations
        echo "Running migrations..."
        docker-compose -f docker/compose/docker-compose.yml exec -T web python manage.py migrate --noinput
        
        # Restart containers
        echo "Restarting containers..."
        docker-compose -f docker/compose/docker-compose.yml up -d
        
        # Clean up old images
        docker image prune -f
        
        echo "=== Deployment complete! ==="
    else
        echo "Push to $refname ignored (not $BRANCH branch)"
    fi
done